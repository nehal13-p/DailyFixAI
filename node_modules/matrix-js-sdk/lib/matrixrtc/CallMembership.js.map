{"version":3,"file":"CallMembership.js","names":["deepCompare","isLivekitFocusActive","isSessionMembershipData","data","checkSessionsMembershipData","errors","_data$focus_active","prefix","device_id","push","call_id","application","focus_active","type","Array","isArray","foci_preferred","created_ts","scope","length","isLegacyCallMembershipData","checkCallMembershipDataLegacy","expires","expires_ts","membershipID","CallMembership","equal","a","b","membershipData","constructor","parentEvent","_defineProperty","sessionErrors","legacyErrors","Error","concat","join","sender","getSender","eventId","getId","callId","deviceId","createdTs","toString","_this$membershipData$","getTs","getAbsoluteExpiry","undefined","getLocalExpiry","relativeCreationTime","localCreationTs","localTimestamp","getMsUntilExpiry","Date","now","isExpired","getPreferredFoci","_this$membershipData$2","foci_active","getFocusSelection","focusActive","focus_selection"],"sources":["../../src/matrixrtc/CallMembership.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { EitherAnd } from \"matrix-events-sdk/lib/types\";\n\nimport { MatrixEvent } from \"../matrix.ts\";\nimport { deepCompare } from \"../utils.ts\";\nimport { Focus } from \"./focus.ts\";\nimport { isLivekitFocusActive } from \"./LivekitFocus.ts\";\n\ntype CallScope = \"m.room\" | \"m.user\";\n// Represents an entry in the memberships section of an m.call.member event as it is on the wire\n\n// There are two different data interfaces. One for the Legacy types and one compliant with MSC4143\n\n// MSC4143 (MatrixRTC) session membership data\n\nexport type SessionMembershipData = {\n    application: string;\n    call_id: string;\n    device_id: string;\n\n    focus_active: Focus;\n    foci_preferred: Focus[];\n    created_ts?: number;\n\n    // Application specific data\n    scope?: CallScope;\n};\n\nexport const isSessionMembershipData = (data: CallMembershipData): data is SessionMembershipData =>\n    \"focus_active\" in data;\n\nconst checkSessionsMembershipData = (data: any, errors: string[]): data is SessionMembershipData => {\n    const prefix = \"Malformed session membership event: \";\n    if (typeof data.device_id !== \"string\") errors.push(prefix + \"device_id must be string\");\n    if (typeof data.call_id !== \"string\") errors.push(prefix + \"call_id must be string\");\n    if (typeof data.application !== \"string\") errors.push(prefix + \"application must be a string\");\n    if (typeof data.focus_active?.type !== \"string\") errors.push(prefix + \"focus_active.type must be a string\");\n    if (!Array.isArray(data.foci_preferred)) errors.push(prefix + \"foci_preferred must be an array\");\n    // optional parameters\n    if (data.created_ts && typeof data.created_ts !== \"number\") errors.push(prefix + \"created_ts must be number\");\n\n    // application specific data (we first need to check if they exist)\n    if (data.scope && typeof data.scope !== \"string\") errors.push(prefix + \"scope must be string\");\n    return errors.length === 0;\n};\n\n// Legacy session membership data\n\nexport type CallMembershipDataLegacy = {\n    application: string;\n    call_id: string;\n    scope: CallScope;\n    device_id: string;\n    membershipID: string;\n    created_ts?: number;\n    foci_active?: Focus[];\n} & EitherAnd<{ expires: number }, { expires_ts: number }>;\n\nexport const isLegacyCallMembershipData = (data: CallMembershipData): data is CallMembershipDataLegacy =>\n    \"membershipID\" in data;\n\nconst checkCallMembershipDataLegacy = (data: any, errors: string[]): data is CallMembershipDataLegacy => {\n    const prefix = \"Malformed legacy rtc membership event: \";\n    if (!(\"expires\" in data || \"expires_ts\" in data)) {\n        errors.push(prefix + \"expires_ts or expires must be present\");\n    }\n    if (\"expires\" in data) {\n        if (typeof data.expires !== \"number\") {\n            errors.push(prefix + \"expires must be numeric\");\n        }\n    }\n    if (\"expires_ts\" in data) {\n        if (typeof data.expires_ts !== \"number\") {\n            errors.push(prefix + \"expires_ts must be numeric\");\n        }\n    }\n\n    if (typeof data.device_id !== \"string\") errors.push(prefix + \"device_id must be string\");\n    if (typeof data.call_id !== \"string\") errors.push(prefix + \"call_id must be string\");\n    if (typeof data.application !== \"string\") errors.push(prefix + \"application must be a string\");\n    if (typeof data.membershipID !== \"string\") errors.push(prefix + \"membershipID must be a string\");\n    // optional elements\n    if (data.created_ts && typeof data.created_ts !== \"number\") errors.push(prefix + \"created_ts must be number\");\n    // application specific data (we first need to check if they exist)\n    if (data.scope && typeof data.scope !== \"string\") errors.push(prefix + \"scope must be string\");\n    return errors.length === 0;\n};\n\nexport type CallMembershipData = CallMembershipDataLegacy | SessionMembershipData;\n\nexport class CallMembership {\n    public static equal(a: CallMembership, b: CallMembership): boolean {\n        return deepCompare(a.membershipData, b.membershipData);\n    }\n    private membershipData: CallMembershipData;\n\n    public constructor(\n        private parentEvent: MatrixEvent,\n        data: any,\n    ) {\n        const sessionErrors: string[] = [];\n        const legacyErrors: string[] = [];\n        if (!checkSessionsMembershipData(data, sessionErrors) && !checkCallMembershipDataLegacy(data, legacyErrors)) {\n            throw Error(\n                `unknown CallMembership data. Does not match legacy call.member (${legacyErrors.join(\" & \")}) events nor MSC4143 (${sessionErrors.join(\" & \")})`,\n            );\n        } else {\n            this.membershipData = data;\n        }\n    }\n\n    public get sender(): string | undefined {\n        return this.parentEvent.getSender();\n    }\n\n    public get eventId(): string | undefined {\n        return this.parentEvent.getId();\n    }\n\n    public get callId(): string {\n        return this.membershipData.call_id;\n    }\n\n    public get deviceId(): string {\n        return this.membershipData.device_id;\n    }\n\n    public get application(): string | undefined {\n        return this.membershipData.application;\n    }\n\n    public get scope(): CallScope | undefined {\n        return this.membershipData.scope;\n    }\n\n    public get membershipID(): string {\n        if (isLegacyCallMembershipData(this.membershipData)) return this.membershipData.membershipID;\n        // the createdTs behaves equivalent to the membershipID.\n        // we only need the field for the legacy member envents where we needed to update them\n        // synapse ignores sending state events if they have the same content.\n        else return this.createdTs().toString();\n    }\n\n    public createdTs(): number {\n        return this.membershipData.created_ts ?? this.parentEvent.getTs();\n    }\n\n    /**\n     * Gets the absolute expiry time of the membership if applicable to this membership type.\n     * @returns The absolute expiry time of the membership as a unix timestamp in milliseconds or undefined if not applicable\n     */\n    public getAbsoluteExpiry(): number | undefined {\n        // if the membership is not a legacy membership, we assume it is MSC4143\n        if (!isLegacyCallMembershipData(this.membershipData)) return undefined;\n\n        if (\"expires\" in this.membershipData) {\n            // we know createdTs exists since we already do the isLegacyCallMembershipData check\n            return this.createdTs() + this.membershipData.expires;\n        } else {\n            // We know it exists because we checked for this in the constructor.\n            return this.membershipData.expires_ts;\n        }\n    }\n\n    /**\n     * Gets the expiry time of the event, converted into the device's local time.\n     * @deprecated This function has been observed returning bad data and is no longer used by MatrixRTC.\n     * @returns The local expiry time of the membership as a unix timestamp in milliseconds or undefined if not applicable\n     */\n    public getLocalExpiry(): number | undefined {\n        // if the membership is not a legacy membership, we assume it is MSC4143\n        if (!isLegacyCallMembershipData(this.membershipData)) return undefined;\n\n        if (\"expires\" in this.membershipData) {\n            // we know createdTs exists since we already do the isLegacyCallMembershipData check\n            const relativeCreationTime = this.parentEvent.getTs() - this.createdTs();\n\n            const localCreationTs = this.parentEvent.localTimestamp - relativeCreationTime;\n\n            return localCreationTs + this.membershipData.expires;\n        } else {\n            // With expires_ts we cannot convert to local time.\n            // TODO: Check the server timestamp and compute a diff to local time.\n            return this.membershipData.expires_ts;\n        }\n    }\n\n    /**\n     * @returns The number of milliseconds until the membership expires or undefined if applicable\n     */\n    public getMsUntilExpiry(): number | undefined {\n        if (isLegacyCallMembershipData(this.membershipData)) {\n            // Assume that local clock is sufficiently in sync with other clocks in the distributed system.\n            // We used to try and adjust for the local clock being skewed, but there are cases where this is not accurate.\n            // The current implementation allows for the local clock to be -infinity to +MatrixRTCSession.MEMBERSHIP_EXPIRY_TIME/2\n            return this.getAbsoluteExpiry()! - Date.now();\n        }\n\n        // Assumed to be MSC4143\n        return undefined;\n    }\n\n    /**\n     * @returns true if the membership has expired, otherwise false\n     */\n    public isExpired(): boolean {\n        if (isLegacyCallMembershipData(this.membershipData)) return this.getMsUntilExpiry()! <= 0;\n\n        // MSC4143 events expire by being updated. So if the event exists, its not expired.\n        return false;\n    }\n\n    public getPreferredFoci(): Focus[] {\n        // To support both, the new and the old MatrixRTC memberships have two cases based\n        // on the availablitiy of `foci_preferred`\n        if (isLegacyCallMembershipData(this.membershipData)) return this.membershipData.foci_active ?? [];\n\n        // MSC4143 style membership\n        return this.membershipData.foci_preferred;\n    }\n\n    public getFocusSelection(): string | undefined {\n        if (isLegacyCallMembershipData(this.membershipData)) {\n            return \"oldest_membership\";\n        } else {\n            const focusActive = this.membershipData.focus_active;\n            if (isLivekitFocusActive(focusActive)) {\n                return focusActive.focus_selection;\n            }\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}